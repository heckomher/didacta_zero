{% extends "base.html" %}

{% block title %}Calendario Semanal{% endblock %}

{% block content %}
    <h1>Calendario Semanal - Semana {{ week }} de {{ year }}</h1>
    <p class="text-muted">{{ start_of_week|date:"d M" }} - {{ end_of_week|date:"d M Y" }}</p>

    <div class="d-flex justify-content-between mb-3">
        <a href="{% url 'calendario_semanal' prev_year prev_week %}" class="btn btn-secondary">&laquo; Semana Anterior</a>
        <div class="btn-group" role="group">
            <a href="{% url 'calendario' %}" class="btn btn-outline-primary">A√±o</a>
            <a href="{% url 'calendario_mensual' year start_of_week.month %}" class="btn btn-outline-primary">Mes</a>
            <a href="#" class="btn btn-primary active">Semana</a>
        </div>
        <a href="{% url 'calendario_semanal' next_year next_week %}" class="btn btn-secondary">Semana Siguiente &raquo;</a>
    </div>

    <div class="row">
        {% for day_info in week_days %}
            <div class="col-md-1 col-sm-6 mb-3">
                <div class="card h-100">
                    <div class="card-header text-center 
                        {% now 'Y-m-d' as today_str %}{% if day_info.date|date:'Y-m-d' == today_str %}bg-primary text-white{% endif %}">
                        <strong>{{ day_info.date|date:"D" }}</strong><br>
                        <span class="h6">{{ day_info.date|date:"d" }}</span>
                    </div>
                    <div class="card-body p-2">
                        {% if day_info.eventos %}
                            {% for evento in day_info.eventos %}
                                <div class="mb-2 p-1 rounded
                                    {% if evento.fecha_inicio.date <= day_info.date and evento.fecha_fin.date >= day_info.date %}
                                        {% if evento.fecha_inicio.date < day_info.date and evento.fecha_fin.date > day_info.date %}
                                            bg-info text-white
                                        {% elif evento.fecha_inicio.date < day_info.date %}
                                            bg-warning
                                        {% elif evento.fecha_fin.date > day_info.date %}
                                            bg-success text-white
                                        {% else %}
                                            bg-light
                                        {% endif %}
                                    {% endif %}">
                                    <small>
                                        {% if evento.fecha_inicio.date == day_info.date and evento.fecha_fin.date == day_info.date %}
                                            <!-- Evento del mismo d√≠a -->
                                            <strong>{{ evento.fecha_inicio|date:"H:i" }}</strong><br>
                                        {% elif evento.fecha_inicio.date == day_info.date %}
                                            <!-- Evento que inicia hoy -->
                                            <strong>{{ evento.fecha_inicio|date:"H:i" }} ‚ñ∂</strong><br>
                                            <span class="badge badge-sm bg-secondary">Inicia</span><br>
                                        {% elif evento.fecha_fin.date == day_info.date %}
                                            <!-- Evento que termina hoy -->
                                            <strong>‚óÄ {{ evento.fecha_fin|date:"H:i" }}</strong><br>
                                            <span class="badge badge-sm bg-secondary">Termina</span><br>
                                        {% else %}
                                            <!-- Evento que contin√∫a -->
                                            <span class="badge badge-sm bg-secondary">Contin√∫a</span><br>
                                        {% endif %}
                                        
                                        <a href="{% url 'calendario_diario' day_info.date.year day_info.date.month day_info.date.day %}" 
                                           class="text-decoration-none">{{ evento.titulo }}</a>
                                        {% if is_admin %}
                                            <br>
                                            <a href="{% url 'evento_editar' evento.pk %}" class="btn btn-sm btn-outline-secondary">‚úèÔ∏è</a>
                                            <a href="{% url 'evento_eliminar' evento.pk %}" class="btn btn-sm btn-outline-danger">üóëÔ∏è</a>
                                        {% endif %}
                                    </small>
                                </div>
                            {% endfor %}
                        {% else %}
                            <small class="text-muted">Sin eventos</small>
                        {% endif %}
                    </div>
                    <div class="card-footer p-1 text-center">
                        <a href="{% url 'calendario_diario' day_info.date.year day_info.date.month day_info.date.day %}" 
                           class="btn btn-sm btn-outline-primary">Ver d√≠a</a>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    {% if is_admin %}
        <div class="text-center mt-4">
            <a href="{% url 'evento_crear' %}" class="btn btn-primary">Crear Evento</a>
        </div>
    {% endif %}

    <!-- Resumen de eventos de la semana -->
    <div class="mt-4">
        <h3>Resumen de la Semana</h3>
        {% with total_eventos=0 %}
            {% for day_info in week_days %}
                {% for evento in day_info.eventos %}
                    {% if forloop.parentloop.first and forloop.first %}
                        <div class="list-group">
                    {% endif %}
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ evento.titulo }}</h6>
                            <small>{{ evento.fecha_inicio|date:"D d M, H:i" }} - {{ evento.fecha_fin|date:"H:i" }}</small>
                        </div>
                        <p class="mb-1">{{ evento.descripcion }}</p>
                    </div>
                {% endfor %}
            {% endfor %}
            {% for day_info in week_days %}
                {% if day_info.eventos %}
                    {% if forloop.last %}
                        </div>
                    {% endif %}
                    {% if forloop.first %}
                        {% comment %} Contador total de eventos {% endcomment %}
                    {% endif %}
                {% endif %}
            {% empty %}
                <p class="text-muted">No hay eventos programados para esta semana.</p>
            {% endfor %}
        {% endwith %}
    </div>
{% endblock %}